
Context for PR #3165176791
Primary language: Rust

PR title:
feat: Add T-SQL dialect support

PR body:
## Summary

This PR adds T-SQL (Microsoft SQL Server) dialect support to sqruff as requested in the review of PR #1658. This is a clean implementation containing only the T-SQL dialect files without any rule modifications.

## Changes

### Core T-SQL Implementation
- Added T-SQL dialect grammar and keywords in `crates/lib-dialects/src/tsql.rs` and `tsql_keywords.rs`
- Registered T-SQL in the dialect system (`crates/lib-core/src/dialects/init.rs`)
- Added T-SQL feature flag in `crates/lib-dialect
...
ed with:
```toml
[sqruff]
dialect = tsql
```

## Notes

This PR has been extracted from #1658 as requested to separate dialect implementation from rule changes. The T-SQL grammar provides a solid foundation with significant parsing improvements. The remaining unparsable sections in 4 test files involve complex nested query structures that can be addressed in future enhancements.

Resolves #689

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>

Diff summary:
CLAUDE.md
@@ -0,0 +1,164 @@
+# CLAUDE.md
+
+This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
+
+## Project Overview
+
+sqruff is a high-speed SQL linter and
...
ptimization settings
+
+## Development Best Practices
+
+- **Testing**: 
+  - Always add a testcase when fixing an issue with a linter, to ensure it will work in the future
\ No newline at end of file
crates/cli/tests/configure_rule/config_all.stderr
@@ -1,4 +1,9 @@
 == [tests/configure_rule/_example.sql] FAIL
+L:   1 | P:  21 | RF03 | Unqualified reference 'table1' found in single table
+                       | select. [references.consistent]
+L
...

 L:   1 | P:  28 | AL01 | Implicit/explicit aliasing of table. [aliasing.table]
 L:   2 | P:   1 | LT12 | Files must end with a single trailing newline.
                        | [layout.end_of_file]
crates/cli/tests/configure_rule/config_all_exclude.stderr
@@ -1,4 +1,9 @@
 == [tests/configure_rule/_example.sql] FAIL
+L:   1 | P:  21 | RF03 | Unqualified reference 'table1' found in single table
+                       | select. [references.consistent]
+L
...
th previous references.
+                       | [references.consistent]
 L:   1 | P:  28 | AL01 | Implicit/explicit aliasing of table. [aliasing.table]
 The linter processed 1 file(s).
 All Finished
crates/lib-core/src/dialects/init.rs
@@ -31,6 +31,7 @@ pub enum DialectKind {
     Sparksql,
     Sqlite,
     Trino,
+    Tsql,
 }
 
 /// Generate a readout of available dialects.
crates/lib-core/src/dialects/syntax.rs
@@ -486,6 +486,7 @@ pub enum SyntaxKind {
     Indent,
     Implicit,
     AtSignLiteral,
+    TsqlVariable,
     QuestionMark,
     RightArrow,
     UdfBody,
crates/lib-dialects/Cargo.toml
@@ -31,6 +31,7 @@ default = [
     "sparksql",
     "sqlite",
     "trino",
+    "tsql",
 ]
 athena = []
 bigquery = []
@@ -45,6 +46,7 @@ snowflake = []
 sparksql = ["hive"]
 sqlite = []
 trino = []
+tsql = []
 
 [dependencies]
 sqruff-lib-core.workspace = true
crates/lib-dialects/src/lib.rs
@@ -49,6 +49,10 @@ mod sqlite_keywords;
 pub mod trino;
 #[cfg(feature = "trino")]
 mod trino_keywords;
+#[cfg(feature = "tsql")]
+pub mod tsql;
+#[cfg(feature = "tsql")]
+mod tsql_keywords;
 
 pub fn
...
       #[cfg(feature = "trino")]
         DialectKind::Trino => trino::dialect(),
+        #[cfg(feature = "tsql")]
+        DialectKind::Tsql => tsql::dialect(),
         _ => return None,
     })
 }
crates/lib-dialects/src/tsql.rs
@@ -0,0 +1,638 @@
+use sqruff_lib_core::dialects::base::Dialect;
+use sqruff_lib_core::dialects::init::DialectKind;
+use sqruff_lib_core::dialects::syntax::SyntaxKind;
+use sqruff_lib_core::helpers::{
...
       "JoinLikeClauseGrammar".into(),
+            Ref::new("ApplyClauseSegment")
+            .to_matchable()
+            .into(),
+        ),
+    ]);
+
+    dialect
+}
\ No newline at end of file
crates/lib-dialects/src/tsql_keywords.rs
@@ -0,0 +1,496 @@
+use ahash::AHashSet;
+
+use crate::ansi_keywords::{ANSI_RESERVED_KEYWORDS, ANSI_UNRESERVED_KEYWORDS};
+
+/// T-SQL reserved keywords from Microsoft documentation
+/// https://learn.
...
tic str> {
+    // Include all future keywords as unreserved keywords
+    // This allows them to be recognized but still used as identifiers
+    tsql_future_keywords()
+}
\ No newline at end of file
crates/lib-dialects/test/fixtures/dialects/tsql/al02_implicit_column_alias.sql
@@ -0,0 +1,50 @@
+-- Test case for AL02: Implicit column aliasing should use AS keyword
+-- This demonstrates the T-SQL specific syntax for column aliasing
+SELECT TOP (@RowLimit)
+    1 AS RecordType
...
.deleted_at IS NULL
+        WHERE
+            ord.order_id = Orders.order_id
+    ) AS Summary
+WHERE
+    Orders.deleted_at IS NULL
+ORDER BY
+    Orders.order_date DESC
\ No newline at end of file
crates/lib-dialects/test/fixtures/dialects/tsql/al02_implicit_column_alias.yml
@@ -0,0 +1,608 @@
+file:
+- statement:
+  - select_statement:
+    - select_clause:
+      - keyword: SELE

First failing CI snippet:


Top review comments:
@benfdking migration is done and all reviews should be applied.
You should be able to review again.
---
looks like I missed one, fixed now.
---
I think for the time being, feel free to just comment out the failing test and maybe even just remove the SQL files that are returning unparseable.
---
I think i can fix some, but the AL05 is unfixable yet, it has known issues.
Will do that tomorrow morning.
---
Amazing and thanks again üôè so very much for this awesome contribution!
---
# T-SQL Dialect Improvements - Comprehensive Update

## üéâ Successfully Fixed Issues (4/5)

### ‚úÖ 1. T-SQL Alias Equals Syntax
**Fixed:** Support for T-SQL's unique alias syntax where the alias comes before the expression
```sql
-- Now correctly parses:
SELECT 
    TotalAmount = SUM(Amount),
    CustomerName = c.Name,
    OrderDate = CONVERT(VARCHAR(10), o.Date, 101)
FROM Orders o
JOIN Customers c ON c.Id = o.CustomerId
```

### ‚úÖ 2. Double Nesting in SelectClauseElementSegment
**Fixed:** Remove
...

- Function name capitalization
- Multi-line comparison operators
- Outer parentheses removal
- Files affected: `AL07.yml`, `CP01.yml`, `CV01.yml`, `CV07.yml`

## Important Notes

1. **All disabled tests are tracked in GitHub issue #1685** which comprehensively documents all known T-SQL limitations.

2. **The problematic commit 074c97b8** that included massive unintended file permission/line ending changes has been successfully reverted and the test disabling changes have been cleanly reapplied.

3. **CI should now pass** - all workspace tests are passing except for Python/Jinja templater tests which require a Python virtual environment (expected in the CI environment).

Each disabled test includes:
- A TODO comment explaining what needs to be fixed
- An `ignored:` field with a descriptive message
- Reference to the GitHub issue #1685

The T-SQL dialect support is still experimental and these tests will need to be re-enabled once the underlying parsing and handling issues are resolved.

Commit messages (for context):
feat: Add T-SQL dialect support

- Add T-SQL dialect implementation with grammar and keywords
- Support T-SQL specific syntax including:
  - Square bracket identifiers []
  - @ variables and table variables
  - TOP clause with PERCENT
  - BEGIN/END blocks
  - DECLARE statements
  - CROSS/OUTER APPLY
  - Alternative alias syntax (alias = expression)
- Add comprehensive test fixtures for T-SQL parsing
- Register T-SQL dialect in the dialect registry
fix: Update T-SQL test fixtures with current par
...
 parent grammar
was already creating the SelectClauseElement node, causing double nesting.

Changes:
- Remove NodeMatcher wrapper from SelectClauseElementSegment replacement
- Now returns the raw one_of matcher directly
- All T-SQL test files updated with correct single-level nesting

The T-SQL alias equals syntax continues to work correctly while fixing
the structural issue in the parse tree.

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>
