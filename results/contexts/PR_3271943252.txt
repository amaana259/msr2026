
Context for PR #3271943252
Primary language: Python

PR title:
fix: add comprehensive global readonly superuser endpoint testing (PROJQUAY-8279)

PR body:
  See Jira for additional testing details. 
  
  Complete endpoint verification with 79 tests showing all read operations (23/23)
  accessible and all write operations (56/56) properly blocked for global readonly
  superusers. Includes feature compliance validation for content discovery, audit
  trail access, and organization settings visibility.

  ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

  Co-Authored-By: Claude <noreply@anthropic.com>
  

Diff summary:
CLAUDE.md
@@ -0,0 +1,329 @@
+# CLAUDE.md
+
+This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
+
+## Project Overview
+
+Project Quay is an enterprise-grade c
...
$TOKEN" "http://localhost:8080/v2/_catalog"
+```
+
+**Note**: The `--tls-verify=false` flag is required for local development since the registry uses HTTP instead of HTTPS.
\ No newline at end of file
COMPLETE_ENDPOINT_TEST_REFERENCE.md
@@ -0,0 +1,1298 @@
+# Complete Endpoint Test Reference
+
+**Test Date:** 2025-07-29  
+**Quay Instance:** http://localhost:8080  
+**Test Users:** quayadmin (Global Read Only Superuser), admin (Normal
...
PLIANCE CONCLUSION:** âœ… **FEATURE FULLY COMPLIANT** - Provides comprehensive compliance and operational oversight capabilities while maintaining strict security boundaries.
\ No newline at end of file
docker-compose.static
@@ -58,7 +58,7 @@ services:
       target: final
     image: localhost/quay-local:latest
     volumes:
-      - "./conf:/quay-registry/conf"
+      - "./endpoints:/quay-registry/endpoints"
       - "./local-dev/stack:/quay-registry/conf/stack"
     ports:
       - "8080:8080"
endpoints/api/__init__.py
@@ -353,7 +353,7 @@ def wrapped(self, namespace, repository, *args, **kwargs):
                 if features.SUPERUSERS_FULL_ACCESS and allow_for_superuser:
                     user = get_authenticate
...
ser(username)
+    logger.debug("allow_if_global_readonly_superuser: user=%s, is_global_readonly=%s", username, is_global_readonly)
+    
+    return is_global_readonly
 
 
 def verify_not_prod(func):
endpoints/api/billing.py
@@ -13,7 +13,7 @@
 from app import app, billing, marketplace_subscriptions, marketplace_users
 from auth import scopes
 from auth.auth_context import get_authenticated_user
-from auth.permissions impo
...
lobalReadOnlySuperUserPermission().can():
             organization = model.organization.get_organization(orgname)
             query = model.organization_skus.get_org_subscriptions(organization.id)
 
endpoints/api/globalmessages.py
@@ -8,6 +8,7 @@
 from auth.permissions import SuperUserPermission
 from endpoints.api import (
     ApiResource,
+    allow_if_superuser,
     nickname,
     require_fresh_login,
     require_scope,
@
...

         Delete a message.
         """
-        if SuperUserPermission().can():
+        if allow_if_superuser():
             model.delete_message(uuid)
             return make_response("", 204)
 
endpoints/api/logs.py
@@ -451,6 +451,10 @@ def post(self, parsed_args):
         """
         Returns the aggregated logs for the current user.
         """
+        # Global readonly superusers should not be able to expor
...
+        if permission.can() or (allow_if_superuser() and not allow_if_global_readonly_superuser()):
             start_time = parsed_args["starttime"]
             end_time = parsed_args["endtime"]
 
endpoints/api/organization.py
@@ -17,6 +17,7 @@
 from auth.permissions import (
     AdministerOrganizationPermission,
     CreateRepositoryPermission,
+    GlobalReadOnlySuperUserPermission,
     OrganizationMemberPermission,
   
...
eadOnlySuperUserPermission().can():
             has_syncing = features.TEAM_SYNCING and bool(authentication.federated_service)
             teams = model.team.get_teams_within_org(org, has_syncing)
 
endpoints/api/repoemail.py
@@ -37,7 +37,7 @@ class RepositoryAuthorizedEmail(RepositoryParamResource):
     Resource for checking and authorizing e-mail addresses to receive repo notifications.
     """
 
-    @require_repo_adm
...
)
+    @require_repo_admin(allow_for_superuser=True, allow_for_global_readonly_superuser=True)
     @nickname("checkRepoEmailAuthorized")
     def get(self, namespace, repository, email):
         """
endpoints/api/repository.py
@@ -28,6 +28,7 @@
 from endpoints.api import (
     ApiResource,
     RepositoryParamResource,
+    allow_if_global_readonly_superuser,
     allow_if_superuser,
     format_date,
     log_action,
@@ -
...
ission(names

First failing CI snippet:


Top review comments:


Commit messages (for context):
fix: add comprehensive global readonly superuser endpoint testing

      Complete endpoint verification with 79 tests showing all read operations (23/23)
      accessible and all write operations (56/56) properly blocked for global readonly
      superusers. Includes feature compliance validation for content discovery, audit
      trail access, and organization settings visibility.

      ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

      Co-Authored-By: Claude <noreply@anthropic.com>
Update config.yaml
