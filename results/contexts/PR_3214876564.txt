
Context for PR #3214876564
Primary language: TypeScript

PR title:
fix: critical issues in action chaining implementation

PR body:
## Summary

This PR addresses all critical issues identified in the action chaining implementation (PR #5436) by both @coderabbitai and @claude reviewers, plus additional robustness improvements found during implementation.

## Changes Made

### ðŸ”´ P0 - Critical Issues Fixed

1. **Memory Leak - Working Memory Cleanup** 
   - Implemented `MAX_WORKING_MEMORY_ENTRIES` limit of 50 entries (configurable)
   - Added automatic cleanup that removes oldest entries when limit is reached
   - Prevents unbou
...
roduction stability concerns

## Next Steps

After this PR is merged, the following improvements can be addressed in follow-up PRs:
- Refactor actionStateProvider complexity (P2)
- Add comprehensive integration tests for multi-action chains
- Implement security sanitization for sensitive values
- Add performance monitoring and metrics
- Consider using Immer for more efficient immutable updates

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>

Diff summary:
packages/core/src/__tests__/action-chaining-simple.test.ts
@@ -0,0 +1,137 @@
+import { describe, expect, it, beforeEach, mock } from 'bun:test';
+import { AgentRuntime } from '../runtime';
+import { createActionResult } from '../types/components';
+import typ
...
n('action_59');
+      expect(cleanedKeys).toContain('action_50');
+      expect(cleanedKeys).not.toContain('action_9'); // Old entry should be removed
+    });
+  });
+});
\ No newline at end of file
packages/core/src/runtime.ts
@@ -516,6 +516,20 @@ export class AgentRuntime implements IAgentRuntime {
     this.evaluators.push(evaluator);
   }
 
+  // Helper functions for immutable action plan updates
+  private updateActionP
...
or result
           const errorResult: ActionResult = {
+            success: false, // Required field
             data: {
               actionName: action.name,
               error: errorMessage,
packages/core/src/types/components.ts
@@ -154,8 +154,8 @@ export interface ActionResult {
   /** Data payload containing action-specific results */
   data?: Record<string, any>;
 
-  /** Whether the action succeeded */
-  success?: boole
...
Result with proper defaults
+ */
+export function createActionResult(partial: Partial<ActionResult> = {}): ActionResult {
+  return {
+    success: true, // Default to success
+    ...partial
+  };
+}
packages/plugin-bootstrap/src/providers/actionState.ts
@@ -73,7 +73,7 @@ export const actionStateProvider: Provider = {
       const formattedResults = actionResults
         .map((result: any, index: number) => {
           const actionName = result.data
...
 actionResults.filter((r: any) => r.success).length,
+        failedActions: actionResults.filter((r: any) => !r.success).length,
       },
       text: allText || 'No action state available',
     };
packages/core/src/runtime.ts
@@ -517,14 +517,14 @@ export class AgentRuntime implements IAgentRuntime {
   }
 
   // Helper functions for immutable action plan updates
-  private updateActionPlan(plan: any, updates: Partial<any>)
...
       ...plan,
-      steps: plan.steps.map((step: any, i: number) => 
+      steps: plan.steps.map((step: S, i: number) => 
         i === index ? { ...step, ...stepUpdates } : step
       )
     };
packages/core/src/specs/v2/__tests__/runtime.test.ts
@@ -386,22 +386,18 @@ describe('AgentRuntime (Non-Instrumented Baseline)', () => {
       expect(paramsArg.runtime.agentId).toBe(runtime.agentId);
       expect(result).toEqual('success');
       // C
...

           call[0]?.type === `useModel:${modelType}` && call[0]?.body?.modelType === modelType
       );
 
-      expect(hasPromptLog).toBe(true);
       expect(hasUseModelLog).toBe(true);
     });
 
packages/core/src/runtime.ts
@@ -901,10 +901,12 @@ export class AgentRuntime implements IAgentRuntime {
           const errorMessage = error instanceof Error ? error.message : String(error);
           this.logger.error(error);

...
actionPlan = updateActionStep(actionPlan, actionIndex, {
+              status: 'failed',
+              error: errorMessage
+            });
           }
 
           // Clear action context on error
packages/core/src/runtime.ts
@@ -521,7 +521,7 @@ export class AgentRuntime implements IAgentRuntime {
     return { ...plan, ...updates };
   }
 
-  private updateActionStep<T, S>(plan: T & { steps: S[] }, index: number, stepUpda
...
ivate updateActionStep<T, S>(plan: T & { steps: S[] }, index: number, stepUpdates: Partial<S>): T & { steps: S[] } {
     return {
       ...plan,
       steps: plan.steps.map((step: S, i: number) => 
packages/core/src/runtime.ts
@@ -903,7 +903,7 @@ export class AgentRuntime implements IAgentRuntime {
 
           // Update plan with error using immutable pattern
           if (actionPlan && actionPlan.steps[actionIndex]) {
- 
...
ateActionStep(actionPlan, actionIndex, {
+            actionPlan = this.updateActionStep(actionPlan, actionIndex, {
               status: 'failed',
               error: errorMessage
             

First failing CI snippet:


Top review comments:
## Pull Request Overview

This PR fixes critical bugs in the action chaining flow by limiting memory growth, enforcing immutable state updates, and tightening type safety.

- Adds a cap and automatic cleanup for working memory entries to prevent leaks  
- Introduces `updateActionPlan`/`updateActionStep` helpers and replaces direct mutations  
- Makes `ActionResult.success` required and provides `createActionResult` helper  
- Adds unit tests covering new helpers and cleanup behavior

### Reviewed Changes

Copilot reviewed 4 out of 4 changed files in this pull request and generated 3 comments.

| File                                                            | Description                                                      |
|-----------------------------------------------------------------|------------------------------------------------------------------|
| packages/plugin-bootstrap/src/providers/actionState.ts         | Switched to required `success` field and updated action counts
...
se vitest and tsup.
```

---

```
Learnt from: CR
PR: elizaOS/eliza#0
File: .cursorrules:0-0
Timestamp: 2025-06-30T09:27:56.771Z
Learning: Applies to **/*.{ts,tsx} : Work on files until they are perfect, looping testing and fixing until all tests pass
```

</details>

---

&lt;!-- This is an auto-generated comment: tweet message by coderabbit.ai --&gt;

If you found this review helpful, would you consider giving us a shout-out on [X](https://twitter.com/intent/tweet?related=CodeRabbitAI&text=Fixing%20critical%20action%20chaining%20bugs%20with%20immutable%20state%20updates%2C%20enforced%20type%20safety%2C%20and%20memory%20leak%20prevention!%20Added%20UUID%20keys%20%26%20bounds%20checks%20for%20robustness.%20Boost%20your%20code%20quality%20with%20%40coderabbitai%20%F0%9F%9A%80%F0%9F%90%87&url=https%3A%2F%2Fgithub.com%2FelizaOS%2Feliza%2Fpull%2F5490)?

Thank you for using CodeRabbit!

&lt;!-- end of auto-generated comment: tweet message by coderabbit.ai --&gt;

</answer></rawResChunk> -->

Commit messages (for context):
Enforce required success field in ActionResult

Refactors ActionResult to require a 'success' boolean, adds a createActionResult helper for defaulting to success=true, and updates all usages to ensure the field is always present. Improves action plan and step updates to be immutable, adds working memory cleanup logic, and updates tests to cover these changes.
Update packages/core/src/runtime.ts

Co-authored-by: Copilot <175728472+Copilot@users.noreply.github.com>
fix: update v2 runtime test expe
...
rs
   - Logs warnings for invalid operations

4. Configuration Enhancement
   - Made MAX_WORKING_MEMORY_ENTRIES configurable
   - Supports both runtime settings and environment variables
   - Defaults to 50 if not specified

5. Test Coverage
   - Updated tests for type-safe sorting
   - Added comprehensive bounds checking tests
   - All tests passing with improved coverage

These changes enhance robustness, prevent edge cases, and improve
maintainability while maintaining backward compatibility.
