
Context for PR #3265640341
Primary language: Swift

PR title:
Add build staleness detection for debug CLI

PR body:
## Summary

  Implements comprehensive build staleness detection to prevent Claude Code from using outdated CLI binaries after source changes. The system provides two layers of
  protection:

  - **Git commit staleness detection**: Compares embedded commit hash vs current repository commit
  - **File modification staleness detection**: Detects when any tracked files have been modified after build time

  ## Changes

  ### Core Implementation
  - âœ… **New BuildStalenessChecker.swift**: 
...
esses M (modified), A (added), R (renamed), etc.
  - **File path handling**: Properly handles quoted paths and special characters
  - **Timestamp comparison**: Uses `stat` to get file modification times

  This enhancement significantly improves the development experience when working with AI coding assistants, ensuring that code changes are always reflected in the CLI
  behavior.

  ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

  Co-Authored-By: Claude <noreply@anthropic.com>

Diff summary:
Apps/CLI/Sources/peekaboo/main.swift
@@ -112,12 +112,83 @@ struct Peekaboo: AsyncParsableCommand {
     )
 }
 
+/// Check if the CLI binary is stale compared to the current git commit.
+/// Only runs in debug builds when git config 'peek
...
staleness in debug mode
+        checkBuildStaleness()
+        #endif
+        
         // Initialize CoreGraphics silently to prevent CGS_REQUIRE_INIT error
         _ = CGMainDisplayID()
         
Apps/CLI/Sources/peekaboo/BuildStalenessChecker.swift
@@ -0,0 +1,176 @@
+import Foundation
+
+/// Check if the CLI binary is stale compared to the current git state.
+/// Only runs in debug builds when git config 'peekaboo.check-build-staleness' is true.
...
 {
+            return modificationDate > buildDate
+        }
+    } catch {
+        // File might not exist or be accessible, skip this check
+        return false
+    }
+    
+    return false
+}
Apps/CLI/Sources/peekaboo/main.swift
@@ -112,71 +112,6 @@ struct Peekaboo: AsyncParsableCommand {
     )
 }
 
-/// Check if the CLI binary is stale compared to the current git commit.
-/// Only runs in debug builds when git config 'peeka
...
}
-}
 
 /// Application entry point.
 ///
@@ -231,3 +166,5 @@ struct Main {
         await Peekaboo.main()
     }
 }
+// Test comment for staleness detection
+// Another test comment added after build
scripts/build-swift-debug.sh
@@ -15,6 +15,7 @@ GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
 GIT_COMMIT_DATE=$(git show -s --format=%ci HEAD 2>/dev/null || echo "unknown")
 GIT_BRANCH=$(git rev-parse --a
...
   static let gitBranch = "$GIT_BRANCH"
+    static let buildDate = "$BUILD_DATE"
     
     static var fullVersion: String {
         return "\(current) (\(gitBranch)/\(gitCommit), \(gitCommitDate))"
scripts/build-swift-universal.sh
@@ -32,6 +32,7 @@ GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
 GIT_COMMIT_DATE=$(git show -s --format=%ci HEAD 2>/dev/null || echo "unknown")
 GIT_BRANCH=$(git rev-parse --a
...
   static let gitBranch = "$GIT_BRANCH"
+    static let buildDate = "$BUILD_DATE"
     
     static var fullVersion: String {
         return "\(current) (\(gitBranch)/\(gitCommit), \(gitCommitDate))"
README.md
@@ -1145,6 +1145,50 @@ The release script creates:
 - `@steipete-peekaboo-mcp-{version}.tgz` - npm package
 - `checksums.txt` - SHA256 checksums for verification
 
+### Debug Build Staleness Detection
...
 especially useful when working with AI coding assistants like Claude Code, which may make multiple changes to the source code and attempt to run the CLI without rebuilding.
+
 ## ðŸ§ª Testing
 
 ```bash
README.md
@@ -1147,47 +1147,7 @@ The release script creates:
 
 ### Debug Build Staleness Detection
 
-When developing Peekaboo, you can enable automatic staleness detection to ensure you're always using the la
...
ion: `git config peekaboo.check-build-staleness true`. This is recommended when working with AI assistants that frequently modify source code, as it prevents using outdated binaries.
 
 ## ðŸ§ª Testing
 
Apps/CLI/Sources/peekaboo/main.swift
@@ -166,5 +166,3 @@ struct Main {
         await Peekaboo.main()
     }
 }
-// Test comment for staleness detection
-// Another test comment added after build
Apps/CLI/Sources/peekaboo/main.swift
@@ -112,7 +112,6 @@ struct Peekaboo: AsyncParsableCommand {
     )
 }
 
-
 /// Application entry point.
 ///
 /// Initializes configuration and launches the command-line parser.

First failing CI snippet:


Top review comments:
### Bug: Git Path Handling Fails in CLI

The CLI's build staleness checker fails to correctly identify modified files due to two path-related issues:
1.  **Incorrect Relative Path Resolution:** When executed from a subdirectory, the checker incorrectly assumes paths returned by `git status --porcelain=1` are relative to the current working directory. These paths are actually relative to the git repository root, leading to incorrect file path construction and missed staleness detections.
2.  **Malformed Renamed File Paths:** The `parseGitStatusOutput` function extracts the full "old_name -> new_name" string for renamed files, instead of just the new filename. This results in attempts to check non-existent, malformed paths, preventing staleness detection for renamed files.

<details>
<summary>Locations (1)</summary>

- [`Apps/CLI/Sources/peekaboo/BuildStalenessChecker.swift#L124-L163`](https://github.com/steipete/Peekaboo/blob/76ef1a9ee64f5df572656774ba6a51d3cb3f9994/Apps/CLI/Sources/pee
...
qYNLhTTDMq4lFc0fxOowxCHjA">Fix in Cursor</a> â€¢ <a href="https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MSJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjgyMjRhYmY2LTliYTYtNGY1Ni1iNTcxLTc3NTU3OWM0MWVkNyIsImVuY3J5cHRpb25LZXkiOiJnWnJKb3NkRS0wT2tnYUhkbXNfOVlpakhQQmpmUGhXWW9vTXFWMEhWQ2xjIiwiYnJhbmNoIjoiQ2xhdWRlLURlYnVnZ2luZy1IZWxwZXIiLCJyZXBvT3duZXIiOiJzdGVpcGV0ZSIsInJlcG9OYW1lIjoiUGVla2Fib28iLCJwck51bWJlciI6MzAsImNvbW1pdFNoYSI6Ijc2ZWYxYTllZTY0ZjVkZjU3MjY1Njc3NGJhNmE1MWQzY2IzZjk5OTQifSwiaWF0IjoxNzUzNTM3MTU0LCJleHAiOjE3NTQxNDE5NTR9.M1PtRjwK87_vRHoFrKiAaCpYlXJrtXtQ-tG3eQDqDwbM7LL7gP83EQkJYOeh_SrXNZVWrjQDClAVFTXTmSkksBWoH96Y2fAuiu2KHP7ITPW7BFn07hDMxQaNmutgVn1lfmElsTagteJtDye4qZSkygWcY8M1rTVmfsjY_eeoYTo3ieTAlbhBH2-YEDdZV5ZgeKj_22Y5CV-J_hxesWXaoUhFHpURakdqD9u4yd5URWI14ggLdvfA5bCmSaXuRlT0QCNXxjwrWZO12IwoP_Uzq03MhdnUWNsYhj3-0hyYzBA8_b4ZY6h5_mdDwmDMY-C1vRwJrMLvVz7oWWhaDqpS-Q">Fix in Web</a>


---
```suggestion
```

Commit messages (for context):
feat: Add build staleness detection for debug CLI

- Add debug-only staleness check using git config 'peekaboo.check-build-staleness'
- CLI will exit with error if current git commit differs from build commit
- Helps prevent Claude Code from using outdated binaries after source changes
feat: Enhance build staleness detection with file modification checks

- Add buildDate timestamp to Version.swift generation
- Create separate BuildStalenessChecker.swift file
- Add comprehensive file modification
...
ow to enable/disable staleness checking via git config
- Explain both git commit and file modification staleness detection
- Provide clear examples and benefits
- Highlight usefulness for AI-assisted development workflows
docs: Simplify staleness detection README section

Replace verbose documentation with single concise paragraph as requested
fix: Remove test comments from main.swift

Clean up debugging comments that were accidentally left in the code
Update Apps/CLI/Sources/peekaboo/main.swift
